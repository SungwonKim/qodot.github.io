Title: [데브옵스 스터디] 09 데이터베이스 문제 추적하기
Slug: [데브옵스-스터디]-09-데이터베이스-문제-추적하기
Date: 2016-07-17
Tags: linux, 데브옵스, 위키북스, 

이 포스트는 `위키북스`가 출판한 [데브옵스](http://www.aladin.co.kr/shop/wproduct.aspx?ItemId=26451777)의 챕터 07 `왜 데이터베이스가 느린가? 데이터베이스 문제 추적하기`를 요약한 내용입니다.

<br>
## 데이터베이스 로그 찾기

데이터베이스 프로세스를 띄울 때 문제가 발생했다면 일단 로그부터 확인해야 한다.

### MySQL

리눅스 배포판에 따라 `/var/log`, `/var/log/mysql`, `/var/lib/mysql` 등의 디렉토리에서 `error.log` 같은 이름의 로그 파일을 찾을 수 있다.

### PostgreSQL

리눅스 배포판에 따라 `/var/log`, `/var/log/postgresql` 등의 디렉토리에서 `postgresql-8.4-main.log` 같은 이름의 로그 파일을 찾을 수 있다.

### 높은 서버 부하

데이터베이스의 특정 단계로 들어가기 앞서, 데이터베이스와 서버가 관계된 문제를 해결하려고 한다면 2장의 높은 부하 원인을 진단하는 방법에 관한 해결법을 먼저 확인한다. 데이터베이스가 부하의 원인인지 파악하기 위해 CPU, RAM, I/O 등의 원인을 살펴봐야 한다.

데이터베이스가 높은 CPU 부하를 발생시킨다면 악성 SQL이 실행되고 있을 확률이 높다. RAM 부하가 있다면 동시에 처리되는 쿼리를 줄이도록 데이터베이스를 튜닝하거나 RAM을 특별히 많이 사용하는 쿼리를 찾아야 한다. I/O 부하가 높을 경우 `iotop`, `sysstat` 등을 이용해서 프로세스 혹은 스토리지에 문제가 있는지 확인한다.

<br>
## 데이터베이스가 정상적으로 실행되고 있는가?

먼저 확인해야 할 것은 데이터베이스가 실행 중이고 올바른 포트를 리스닝하고 있느냐이다. 그 다음은 해당 포트를 원격에서 사용할 수 있는지를 확인한다(네트워크 문제).

### MySQL

데비안 기준으로 아래 명령어를 통해 프로세스 상태 정보를 확인할 수 있다.

```bash
$ sudo service mysql status
mysql start/running, prcess 735
```

서비스 뒤의 초기화 스크립트 이름은 `/etc/init.d` 혹은 `/etc/rc.d/init.d` 디렉토리에서 확인할 수 있다.

`ps`와 `grep`를 조합해서 확인할 수도 있다.

```bash
$  ps -ef | grep mysql
mysql   735 1   0   Jun12   ?   02:02:56    /usr/sbin/mysqld
```

프로세스가 실행되고 있는 것을 확인했다면, 포트를 확인해보자.

```bash
$ sudo netstat -lnp | grep :3306
tcp     0   0   127.0.0.1:3306      0.0.0.0:*   LISTEN  735/mysqld
```

 프로세스 ID가 방금 전 프로세스를 확인 할 때 나온 ID가 같은지 비교해본다. 방금 위의 `netstat` 결과를 보면 로컬호스트(127.0.0.1)에서의 3306 포트만 리슨하고 있는 것을 확인 할 수 있는데, 이것은 웹서버와 데이터베이스가 같은 장비에 있지 않으면 문제가 발생할 수 있다는 것을 의미한다.
 
 ### PostgreSQL
 
 MySQL과 유사하게 확인이 가능하다
 
 ```bash
 $ sudo service postgresql-8.4 status
 Running clusters: 8.4/main
 ```
 
```bash
$ ps -ef | grep postgres
postgres 1629   1   0   Jul10   ?   00:00:06    /usr/lib/postgresql/8.4/bin/postgres -D /var/lib/postgresql/8.4/main -c config_file=/etc/postgresql/8.4/main/postgresql.conf
postgres 1631   1629    0   Jul10   ?   00:00:38    postgres: writer process
postgres 1632   1629    0   Jul10   ?   00:00:30    postgres: wal writer process
postgres 1633   1629    0   Jul10   ?   00:00:38    postgres: autovacuum launcher process
postgres 1634   1629    0   Jul10   ?   00:00:38    postgres: stats collector process
```

MySQL과 다르게 기본적으로 역할별로 여러개의 프로세스가 생성된다. PostgreSQL은 기본적으로 5432 포트를 리슨하기 때문에 아래와 같이 netstat 명령어를 실행할 때 참조하자.

<br>
## 데이터베이스 성능 지표 구하기

### MySQL

지표를 가져오기 위해 `mysqladmin` 도구를 사용하다. 이 도구는 MySQL 클라이언트 소프트웨어의 구성요소로 설치해야 한다.

```bash
$ mysqladmin -u root -p status
Enter password:
Uptime: 2680987     Threads: 1  Questions: 17494181     Slow queries: 0     Opens: 2096     Flush tables: 1     Open tables: 64     Queries per second avg: 6.525
```

- Uptime: MySQL 서버의 총 실행 시간 (초)
- Threads: 활성화된 스레드 수 (클라이언트)
- Questions: 서버가 시작된 이후 클라이언트로부터 요청받은 쿼리의 수
- Slow queries: long_query_time 초 보다 길게 실행된 쿼리의 수
- Opens: 서버가 열어 본 테이블의 수
- Flush tables: 서버가 실행했던 flush-*, refresh, reload 명령의 횟수
- Open tables: 현재 열려 있던 테이블의 수
- Queries per second avg: 데이터베이스가 받은 초당 평균 쿼리의 수

`exteded-status` 명령을 사용하면 더 자세한 정보를 얻을 수 있다

```bash
$ mysqladmin -u root -p extended-status
Enter password:
+-----------------------------------+------------------+
| variable_name                     |  value           |
+-----------------------------------+------------------+
| aborted_clients                   | 0                |
| aborted_connects                  | 5                |
...
```

### PostgreSQL

PostgreSQL은 `postgresql.conf` 파일을 확인해, `track_activities`, `track_counts` 값이 모두 on으로 설정되어 있는지 확인한다. 이 설정은 통계 정보 수집을 활성화하는 옵션이고, 이 옵션을 적용하려면 재시작이 필요하다.

수집된 데이터는 데이터베이스의 특정 테이블에 저장된다. 따라서 통계 데이터를 가져오려면 SQL을 사용해야 한다. 이 데이터베이스에 접근하려면 postgres 사용자 권한이 있어야 한다.

```bash
$ su - postgres
$ psql
psql (8.4.12)
Type "help" for help.
```

#### pg\_stat\_activity

`pg_stat_activity` 테이블은 서버 프로세스가 접근하고 있는 데이터베이스, 시스템 프로세스, 사용자, 현재 쿼리, 쿼리가 수행된 시간 등 현재 실행 중인 서버 프로세스에 대한 정보를 보여준다.

![pgstatactivity]({filename}/images/pgstatactivity.png)

### pg\_stat\_database

해당 데이터베이스에 연결된 서버 프로세스 수, 커밋/롤백 트랜잭션 수, 블록과 row 통계 등이 저장된다.

![pgstatdatabase]({filename}/images/pgstatdatabase.png)

### pg\_stat\_all\_tables

순차 스캔 통계, 인덱스 스캔 통계, 테이블에 대해 수행된 다른 오퍼레이션 횟수에 관한 데이터 등 테이블 단위의 통계 정보가 저장된다.

![pgstatalltables]({filename}/images/pgstatalltables.png)

<br>
## 느린 쿼리 확인하기

### MySQL

`log_slow_queries`를 통해 느린 쿼리에 대한 로그를 저장할 파일을 지정하고, `long_query_time`을 느린 쿼리의 기준을 설정한다. 기본적으로 이 두 값은 설정 파일에서 주석처리 되어 있으므로 이를 풀어 설정하고 프로세스를 재시작 해야한다.

### PostgreSQL

`log_min_duration_statement`로 느린 쿼리의 기준을 설정한다. 이 값이 -1이라면 아무것도 로깅되지 않고, 0이라면 모든 쿼리가 로깅된다. 이 값은 밀리초 단위이다. 값을 설정한 후 프로세스를 재시작해야 한다.
