<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>waiting for qodot</title>
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta http-equiv="imagetoolbar" content="no">
        <meta http-equiv="pragma" content="cache">
        <meta http-equiv="cache-control" content="cache">
        <meta http-equiv="vary" content="content-language">
        <meta http-equiv="Cache-control" content="max-age=2592000, public">
        <meta http-equiv="content-style-type" content="text/css">
        <link rel="dns-prefetch" href="https://qodot.github.io"/>
        <link rel="dns-prefetch" href="//www.gstatic.com"/>
        <link rel="dns-prefetch" href="//fonts.gstatic.com"/>
        <link rel="dns-prefetch" href="//fonts.googleapis.com"/>
        <link rel="dns-prefetch" href="//twemoji.maxcdn.com"/>
        <link rel="dns-prefetch" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400"/>
        <link rel="stylesheet" type="text/css" href="https://qodot.github.io/theme/css/screen.min.css">
        <link rel="stylesheet" type="text/css" href="https://qodot.github.io/theme/css/highlight.min.css">
        <link rel="stylesheet" type="text/css" href="https://qodot.github.io/theme/css/custom.min.css">
        <link rel="stylesheet" type="text/css" href="https://qodot.github.io/theme/css/twemoji-awesome.min.css">
        <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
        <link rel="publisher" href="">
        <link rel="apple-touch-startup-image" href="https://qodot.github.io/theme/images/logo.png">
        <link type="text/plain" rel="socialmedia" href="https://qodot.github.io/socialmedia.txt">
        <meta http-equiv="content-type" content="text/html;charset=utf-8">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
        <meta name="apple-mobile-web-app-capable" content="yes"/>
        <meta name="application-name" content="waiting for qodot"/>
        <meta name="msapplication-starturl" content="http:https://qodot.github.io"/>
        <meta name="msapplication-tooltip" content=""/>
        <meta name="msapplication-window" content="width=1024;height=768"/>
        <meta name="msapplication-task" content="name=waiting for qodot;action-uri=http:https://qodot.github.io;icon-uri=https://qodot.github.io/theme/images/favicon.ico"/>
        <meta name="msapplication-TileImage" content="https://qodot.github.io/theme/images/apple-touch-icon-144x144.png"/>
        <meta name="msapplication-TileColor" content="#1F1F21"/>
        <meta name="application-name" content="waiting for qodot">
        <meta name="HandheldFriendly" content="True">
        <meta name="MobileOptimized" content="320"/>
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="google-site-verification" content="">
        <meta name="alexaVerifyID" content=""/>
        <meta name="wot-verification" content=""/>
        <meta name="msvalidate.01" content="" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <meta name="medium" content="mult">
        <meta name="adblock" content="disable">
        <meta name="rating" content="General">
        <meta name="resource-type" content="document">
        <meta name="revisit-after" content="1 days">
        <meta name="revisit" content="1">
        <meta name="robots" content="index,follow">
        <meta name="no-email-collection" content="http://www.unspam.com/noemailcollection/">
        <meta name="twitter:card" content="summary">
        <meta name="twitter:site" content="@">
        <meta property="og:site_name" content="waiting for qodot">
        <meta property="og:locale" content="en">
        <link rel="canonical" href="https://qodot.github.io/Python으로-텔레그램-봇-만들기.html">
        <meta property="og:type" content="article">
        <meta property="og:title" content="Python으로 텔레그램 봇 만들기">
        <meta property="og:url" content="Python으로-텔레그램-봇-만들기.html">
        <meta property="og:description" content="개요 및 기획 회사에 있는 하루 중 가장 힘든 시간은 바로 점심을 뭘 먹을지 결정하는 순간이다. 사실 누구든 아무거나 먹어도 상관 없는데 아무도 결정하지 못하는 상황을 자주 마주치게 된다. 그래서 나는 우리 대신 빠른 결정을 내려줄 무언가가 필요하다고 생각했다. 식당을 등록/제거하고, 등록된 식당을 조회하고, 등록된 식당 중에 하나를 랜덤으로 …">
        <meta property="article:published_time" content="일요일, 3월 06, 2016">
        <meta name="twitter:title" content="Python으로 텔레그램 봇 만들기">
        <meta name="twitter:description" content="개요 및 기획 회사에 있는 하루 중 가장 힘든 시간은 바로 점심을 뭘 먹을지 결정하는 순간이다. 사실 누구든 아무거나 먹어도 상관 없는데 아무도 결정하지 못하는 상황을 자주 마주치게 된다. 그래서 나는 우리 대신 빠른 결정을 내려줄 무언가가 필요하다고 생각했다. 식당을 등록/제거하고, 등록된 식당을 조회하고, 등록된 식당 중에 하나를 랜덤으로 …">
        <meta name="description" content="개요 및 기획 회사에 있는 하루 중 가장 힘든 시간은 바로 점심을 뭘 먹을지 결정하는 순간이다. 사실 누구든 아무거나 먹어도 상관 없는데 아무도 결정하지 못하는 상황을 자주 마주치게 된다. 그래서 나는 우리 대신 빠른 결정을 내려줄 무언가가 필요하다고 생각했다. 식당을 등록/제거하고, 등록된 식당을 조회하고, 등록된 식당 중에 하나를 랜덤으로 …">
        <meta name="twitter:creator" content="@">
        <meta property="og:image" content="https://qodot.github.io/theme/images/logo.png">
        <meta name="twitter:image" content="https://qodot.github.io/theme/images/logo.png">
        <meta property="og:image:type" content="image/png">
        <meta property="og:image:width" content="300">
        <meta property="og:image:height" content="300">
        <meta property="article:section" content="py">
        <meta property="article:tag" content="python">
        <meta property="article:tag" content="telegrambot">
        <meta property="article:author" content="qodot">
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-83522208-2', 'auto');
            ga('send', 'pageview');
        </script>
    </head>
    <body class="post-template nav-closed" itemscope itemtype="http://schema.org/WebPage">
        <meta itemprop="name" content="waiting for qodot">
        <meta itemprop="url" content="https://qodot.github.io">
        <meta itemprop="headline" content="waiting for qodot || ">
        <meta itemprop="description about" content="">
        <meta itemprop="keywords" content="">
        <meta itemprop="inLanguage" content="en">
<nav class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul role="menubar">
        <li class="" role="presentation"><a  href="https://qodot.github.io/index.html" title="waiting for qodot" itemprop="name" itemprop="significantLink">Home</a></li>
            <li class="" role="presentation"><a  href="https://qodot.github.io/category/py.html" title="waiting for qodot |@ py" itemprop="name" itemprop="significantLink">@ py</a></li>
            <li class="" role="presentation"><a  href="https://qodot.github.io/category/env.html" title="waiting for qodot |@ env" itemprop="name" itemprop="significantLink">@ env</a></li>
            <li role="presentation"><a  href="https://github.com/qodot" title="* github" itemprop="name" itemprop="significantLink">* github</a></li>
            <li role="presentation"><a  href="https://www.facebook.com/daewon.seo.5" title="* facebook" itemprop="name" itemprop="significantLink">* facebook</a></li>
            <li role="presentation"><a  href="https://rateyourmusic.com/~qodot" title="* rateyourmusic" itemprop="name" itemprop="significantLink">* rateyourmusic</a></li>
            <li role="presentation"><a  href="http://www.last.fm/user/qodot" title="* lastfm" itemprop="name" itemprop="significantLink">* lastfm</a></li>
            <li class="" role="presentation"><a  href="https://qodot.github.io/archives.html" title="waiting for qodot | Archives" itemprop="name" itemprop="significantLink">Archives</a></li>
    </ul>
</nav>
<span class="nav-cover"></span>        <div class="site-wrapper">
            <header class="main-header post-head" style="background-image: url('/images/default_header.png');" itemscope itemtype="http://schema.org/WPHeader">
                <nav class="main-nav overlay clearfix">
                    <a class="menu-button" href="#">
                        <span class="burger">&#9776;</span>
                        <span class="word">Menu</span>
                    </a>
                </nav>
                <div class="vertical">
                    <div class="main-header-content inner">
                    </div>
                </div>
            </header>
<main id="content" class="content" role="main">
    <article class="post" itemscope="" itemtype="http://schema.org/BlogPosting" itemprop="blogPost">
        <header class="post-header">
            <h1 class="post-title" itemprop="headline">Python으로 텔레그램 봇 만들기</h1>
            <section class="post-meta">
                <time class="post-date" itemprop="datePublished" datetime="2016YYY-00M-%DD">일요일, 3월 06, 2016</time>
                on <a href="tag/python.html">Python, </a><a href="tag/telegrambot.html">Telegrambot</a>            </section>
        </header>
        <section class="post-content">
            <h2>개요 및 기획</h2>
<p>회사에 있는 하루 중 가장 힘든 시간은 바로 점심을 뭘 먹을지 결정하는 순간이다. 사실 누구든 아무거나 먹어도 상관 없는데 아무도 결정하지 못하는 상황을 자주 마주치게 된다. 그래서 나는 우리 대신 빠른 결정을 내려줄 무언가가 필요하다고 생각했다.</p>
<p>식당을 등록/제거하고, 등록된 식당을 조회하고, 등록된 식당 중에 하나를 랜덤으로 뽑아줄 기능이 필요했다. 그런데 이렇게 간단한 기능을 웹서비스로 구현하는 것은 불필요하게 큰 작업이라는 생각이 들었고, 마침 평소에 궁금해 했던 텔레그램 봇 API를 이용해서 만들면 적절하겠다라는 생각을 했다.</p>
<p><br></p>
<h2>Bot Token 얻기</h2>
<p>텔레그램을 pc나 스마트 기기에 설치하고, 친구 검색창에 <code>@BotFather</code>를 입력해서 봇 파더와 대화를 시작한다. 봇 파더에게 <code>/start</code>, <code>/newbot</code> 명령어를 차례로 입력하고, 프로젝트 이름과 봇의 이름을 입력하면 access token을 준다. 이것을 잘 저장해놓고 있자.</p>
<p><br></p>
<h2>Telepot 설치</h2>
<p><a href="https://core.telegram.org/bots/api">텔레그램의 공식 봇 API 문서</a>를 봐도 되지만, 더 간단한 방법이 있다. 봇 API를 wrapping한 telepot(<a href="https://github.com/nickoala/telepot">github</a>)을 쓰면 된다.</p>
<p>적절히 python 환경을 구성한 뒤, telepot을 설치한다.</p>
<div class="highlight"><pre><span></span>pip install telepot
</pre></div>


<p>기본적인 사용법은 telepot github 페이지에 잘 정리되어 있다. 그 중에서도 더 기본적인 기능만 소개해보면,</p>
<div class="highlight"><pre><span></span><span class="c1"># 봇 생성</span>
<span class="n">bot</span> <span class="o">=</span> <span class="n">telepot</span><span class="o">.</span><span class="n">Bot</span><span class="p">(</span><span class="n">YOUR_ACCESS_TOKEN</span><span class="p">)</span>

<span class="c1"># 메세지 수신 대기 (busy waiting)</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="n">bot</span><span class="o">.</span><span class="n">notifyOnMessage</span><span class="p">(</span><span class="n">callback_function_to_handle_message</span><span class="p">)</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># 메세지 발신</span>
<span class="n">bot</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">sending_message</span><span class="p">)</span>
</pre></div>


<p>메세지 발신시의 <code>target</code>은 수신 메세지에 들어있는 <code>chat_id</code>이다. (수신된 메세지를 출력해 보면 구조를 자세히 알 수 있다.)</p>
<p>이를 잘 조합해서 간단하게 필요한 기능을 구현할 수 있다. 커스텀 키보드를 유저에게 노출시켜서 편리한 UX을 제공할 수도 있으니, 이용해 보면 좋을 것 같다.</p>
<p><br></p>
<h2>SQLAlchemy</h2>
<h3>설치</h3>
<p>등록한 음식점을 데이터베이스에 저장해 놓아야 다음에 다시 등록하는 일 없이 사용할 수 있기 때문에, SQLAlchemy와 SQLite를 이용해서 간단하게 데이터베이스를 구현해 보자.</p>
<p>SQLAlchemy에 대한 기본적인 소개와 튜토리얼은 <a href="http://haruair.com/blog/1682">Haruair님의 SQLAlchemy 시작하기</a>에 잘 정리되어 있으니 참고바란다.</p>
<p>다음 명령어로 설치한다.</p>
<div class="highlight"><pre><span></span>pip install sqlalchemy
</pre></div>


<h3>Scheme 생성</h3>
<p>다음은 데이터베이스 연결을 수행하고, 식당의 테이블 정보를 담고있는 SQLAlchemy 모델 정보가 담겨있는 <code>db.py</code> 파일이다.</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">DateTime</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">sessionmaker</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="n">declarative_base</span>


<span class="c1"># 데이터베이스 연결 및 세션 취득</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s1">&#39;sqlite:///db.sqlite3&#39;</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)()</span> <span class="c1">#</span>
<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>


<span class="c1"># 식당 테이블</span>
<span class="k">class</span> <span class="nc">Restaurant</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;restaurants&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">created_at</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
    <span class="n">updated_at</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">,</span> <span class="n">onupdate</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</pre></div>


<p>위의 <code>session</code> 변수를 통해 데이터베이스에 접속해서 쿼리를 실행할 수 있다.</p>
<h3>Migration</h3>
<p>이제 저 Python class를 이용해 실제 데이터베이스의 테이블로 만들어줘야 하는데, 여러가지 방법이 있다.</p>
<ol>
<li>직접 데이터베이스에 접속해서 <code>create table</code> 쿼리를 날린다.</li>
<li>sqlalchemy의 <code>Base.metadata.create_all(engine)</code>를 이용해서 자동으로 테이블을 생성한다.</li>
<li>Alembic을 이용해서 마이그레이션 한다.</li>
</ol>
<p>1번은 너무 귀찮고, 2번의 경우 테이블 생성은 되지만 테이블 변경은 자동으로 되지 않는 문제가 있어서(프로젝트가 단순해서 변경할 일이 없다면 문제 없겠지만) 3번을 선택했다. Alembic은 SQLAlchemy를 위한 마이그레이션 툴이고, 이전에 작성했던 <a href="http://qodot.github.io/Alembic-%ED%80%B5-%EA%B0%80%EC%9D%B4%EB%93%9C.html">Alembic 퀵 가이드</a>에서 간단하게 소개한 적이 있다. 참고하길 바란다.</p>
<h3>사용</h3>
<p>1, 2, 3번 중 하나를 선택해서 테이블 스키마를 생성했다면, 이제 데이터베이스에 접속해서 쿼리를 날려볼 차례인데, 여기서는 이 프로젝트에서 사용한 기본적인 select, insert, delete 동작의 예시를 소개해 본다.</p>
<div class="highlight"><pre><span></span><span class="c1"># 식당 테이블의 모든 row 조회</span>
<span class="n">restaurants</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Restaurant</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

<span class="c1"># 식당 테이블의 모든 row 갯수 조회</span>
<span class="n">restaurants_count</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Restaurant</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

<span class="c1"># 새 식당 등록</span>
<span class="n">restaurant</span> <span class="o">=</span> <span class="n">Restaurant</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
<span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">restaurant</span><span class="p">)</span>
<span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

<span class="c1"># 특정 이름을 가진 식당 하나를 제거</span>
<span class="n">restaurant</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Restaurant</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Restaurant</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">restaurant</span><span class="p">)</span>
<span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>


<p><br></p>
<h2>개선점</h2>
<p>Telepot과 SQLAlchemy를 이용해서 텔레그램 봇을 만들 수 있다. 그런데 실제로 봇을 운영하려면 Python 스크립트를 리눅스 데몬이나 서비스로 띄우는 방법에 대한 고려가 되어야 한다. 그리고 이벤트 listen을 담당하는 부분이 busy waiting 방식으로 구현되어 있는데 <code>asyncio</code>를 이용한 비동기 방식으로 구현하는 것이 더 좋을 것이다. 특히 두 번 째 부분은 공부가 많이 필요한 부분이라... 따로 포스트를 작성하면서 정리해야 겠다.</p>
        </section>
        <footer class="post-footer">
            <figure class="author-image">
                <a class="img" href="author/qodot.html" style="background-image: url('/images/profile.png')"><span class="hidden">qodot's Picture</span></a>
            </figure>
            <section class="author">
                <h4>
                    <a href="author/qodot.html">qodot</a>
                </h4>
                <p>Python Developer</p>
                <div class="author-meta">
                    <span class="author-location icon-location">Seoul, South Korea</span>                 </div>
            </section>
            <section class="share">
                <h4>Share this post</h4>
                <a class="icon-twitter" href="https://twitter.com/share?text=Python%EC%9C%BC%EB%A1%9C%20%ED%85%94%EB%A0%88%EA%B7%B8%EB...%20via%20%40&amp;url=https://qodot.github.io/Python으로-텔레그램-봇-만들기.html" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://qodot.github.io/Python으로-텔레그램-봇-만들기.html" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=https://qodot.github.io/Python으로-텔레그램-봇-만들기.html" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>
 <section>
<h2>Comments !</h2>
<div id="disqus_thread"></div>
<script type="text/javascript">var disqus_identifier = "Python으로-텔레그램-봇-만들기.html";(function(){var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;dsq.src = '//qodot.disqus.com/embed.js';(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);})();</script>
</section>         </footer>
    </article>
</main>
<aside class="read-next">
</aside>             <footer class="site-footer clearfix" role="contentinfo" itemscope itemtype="http://schema.org/WPFooter">
                <section class="copyright">
                    <a itemprop="url" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">
                        CC Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
                </section>
                <section class="poweredby">
                    Proudly published with
                    <a itemprop="url" href="https://getpelican.org" target="_blank">Pelican</a>
                </section>
            </footer>
        </div>
    <script type="text/javascript" src="https://qodot.github.io/theme/js/jquery-1.11.2.min.js"></script>
    <script type="text/javascript" src="https://qodot.github.io/theme/js/jquery.fitvids.min.js"></script>
    <script type="text/javascript" src="https://qodot.github.io/theme/js/index.min.js"></script>
    </body>
</html>