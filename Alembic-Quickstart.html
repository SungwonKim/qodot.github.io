<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>waiting for qodot</title>
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta http-equiv="imagetoolbar" content="no">
        <meta http-equiv="pragma" content="cache">
        <meta http-equiv="cache-control" content="cache">
        <meta http-equiv="vary" content="content-language">
        <meta http-equiv="Cache-control" content="max-age=2592000, public">
        <meta http-equiv="content-style-type" content="text/css">
        <link rel="dns-prefetch" href="https://qodot.github.io"/>
        <link rel="dns-prefetch" href="//www.gstatic.com"/>
        <link rel="dns-prefetch" href="//fonts.gstatic.com"/>
        <link rel="dns-prefetch" href="//fonts.googleapis.com"/>
        <link rel="dns-prefetch" href="//twemoji.maxcdn.com"/>
        <link rel="dns-prefetch" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400"/>
        <link rel="stylesheet" type="text/css" href="https://qodot.github.io/theme/css/screen.min.css">
        <link rel="stylesheet" type="text/css" href="https://qodot.github.io/theme/css/highlight.min.css">
        <link rel="stylesheet" type="text/css" href="https://qodot.github.io/theme/css/custom.min.css">
        <link rel="stylesheet" type="text/css" href="https://qodot.github.io/theme/css/twemoji-awesome.min.css">
        <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
        <link rel="publisher" href="">
        <link rel="apple-touch-startup-image" href="https://qodot.github.io/theme/images/logo.png">
        <link type="text/plain" rel="socialmedia" href="https://qodot.github.io/socialmedia.txt">
        <meta http-equiv="content-type" content="text/html;charset=utf-8">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
        <meta name="apple-mobile-web-app-capable" content="yes"/>
        <meta name="application-name" content="waiting for qodot"/>
        <meta name="msapplication-starturl" content="http:https://qodot.github.io"/>
        <meta name="msapplication-tooltip" content=""/>
        <meta name="msapplication-window" content="width=1024;height=768"/>
        <meta name="msapplication-task" content="name=waiting for qodot;action-uri=http:https://qodot.github.io;icon-uri=https://qodot.github.io/theme/images/favicon.ico"/>
        <meta name="msapplication-TileImage" content="https://qodot.github.io/theme/images/apple-touch-icon-144x144.png"/>
        <meta name="msapplication-TileColor" content="#1F1F21"/>
        <meta name="application-name" content="waiting for qodot">
        <meta name="HandheldFriendly" content="True">
        <meta name="MobileOptimized" content="320"/>
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="google-site-verification" content="">
        <meta name="alexaVerifyID" content=""/>
        <meta name="wot-verification" content=""/>
        <meta name="msvalidate.01" content="" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <meta name="medium" content="mult">
        <meta name="adblock" content="disable">
        <meta name="rating" content="General">
        <meta name="resource-type" content="document">
        <meta name="revisit-after" content="1 days">
        <meta name="revisit" content="1">
        <meta name="robots" content="index,follow">
        <meta name="no-email-collection" content="http://www.unspam.com/noemailcollection/">
        <meta name="twitter:card" content="summary">
        <meta name="twitter:site" content="@">
        <meta property="og:site_name" content="waiting for qodot">
        <meta property="og:locale" content="en">
        <link rel="canonical" href="https://qodot.github.io/Alembic-Quickstart.html">
        <meta property="og:type" content="article">
        <meta property="og:title" content="Alembic Quickstart">
        <meta property="og:url" content="Alembic-Quickstart.html">
        <meta property="og:description" content="개요 Rails나 Django 같은 모던 웹 프레임워크의 ORM에서는, 반복되는 DB 스키마 변경을 수월하게 진행 할 수 있도록 전용 마이그레이션 툴이 ORM에 내장되어 있다. 그러나 SQLAlchemy에서는 기본적으로 테이블의 생성은 가능하나, 생성된 테이블의 스키마 변경은 지원하지 않는데, 이를 수월하게 만들어 주는 툴이 바로 Alembic이다. 설치 그냥 pip으로 설치한다. pip install alembic …">
        <meta property="article:published_time" content="수요일, 11월 25, 2015">
        <meta name="twitter:title" content="Alembic Quickstart">
        <meta name="twitter:description" content="개요 Rails나 Django 같은 모던 웹 프레임워크의 ORM에서는, 반복되는 DB 스키마 변경을 수월하게 진행 할 수 있도록 전용 마이그레이션 툴이 ORM에 내장되어 있다. 그러나 SQLAlchemy에서는 기본적으로 테이블의 생성은 가능하나, 생성된 테이블의 스키마 변경은 지원하지 않는데, 이를 수월하게 만들어 주는 툴이 바로 Alembic이다. 설치 그냥 pip으로 설치한다. pip install alembic …">
        <meta name="description" content="개요 Rails나 Django 같은 모던 웹 프레임워크의 ORM에서는, 반복되는 DB 스키마 변경을 수월하게 진행 할 수 있도록 전용 마이그레이션 툴이 ORM에 내장되어 있다. 그러나 SQLAlchemy에서는 기본적으로 테이블의 생성은 가능하나, 생성된 테이블의 스키마 변경은 지원하지 않는데, 이를 수월하게 만들어 주는 툴이 바로 Alembic이다. 설치 그냥 pip으로 설치한다. pip install alembic …">
        <meta name="twitter:creator" content="@">
        <meta property="og:image" content="https://qodot.github.io/theme/images/logo.png">
        <meta name="twitter:image" content="https://qodot.github.io/theme/images/logo.png">
        <meta property="og:image:type" content="image/png">
        <meta property="og:image:width" content="300">
        <meta property="og:image:height" content="300">
        <meta property="article:section" content="py">
        <meta property="article:tag" content="python">
        <meta property="article:tag" content="alembic">
        <meta property="article:tag" content="sqlalchemy">
        <meta property="article:author" content="qodot">
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-83522208-2', 'auto');
            ga('send', 'pageview');
        </script>
    </head>
    <body class="post-template nav-closed" itemscope itemtype="http://schema.org/WebPage">
        <meta itemprop="name" content="waiting for qodot">
        <meta itemprop="url" content="https://qodot.github.io">
        <meta itemprop="headline" content="waiting for qodot || ">
        <meta itemprop="description about" content="">
        <meta itemprop="keywords" content="">
        <meta itemprop="inLanguage" content="en">
<nav class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul role="menubar">
        <li class="" role="presentation"><a  href="https://qodot.github.io/index.html" title="waiting for qodot" itemprop="name" itemprop="significantLink">Home</a></li>
            <li class="" role="presentation"><a  href="https://qodot.github.io/category/py.html" title="waiting for qodot |@ py" itemprop="name" itemprop="significantLink">@ py</a></li>
            <li class="" role="presentation"><a  href="https://qodot.github.io/category/env.html" title="waiting for qodot |@ env" itemprop="name" itemprop="significantLink">@ env</a></li>
            <li role="presentation"><a  href="https://github.com/qodot" title="* github" itemprop="name" itemprop="significantLink">* github</a></li>
            <li role="presentation"><a  href="https://www.facebook.com/daewon.seo.5" title="* facebook" itemprop="name" itemprop="significantLink">* facebook</a></li>
            <li role="presentation"><a  href="https://rateyourmusic.com/~qodot" title="* rateyourmusic" itemprop="name" itemprop="significantLink">* rateyourmusic</a></li>
            <li role="presentation"><a  href="http://www.last.fm/user/qodot" title="* lastfm" itemprop="name" itemprop="significantLink">* lastfm</a></li>
            <li class="" role="presentation"><a  href="https://qodot.github.io/archives.html" title="waiting for qodot | Archives" itemprop="name" itemprop="significantLink">Archives</a></li>
    </ul>
</nav>
<span class="nav-cover"></span>        <div class="site-wrapper">
            <header class="main-header post-head" style="background-image: url('/images/default_header.png');" itemscope itemtype="http://schema.org/WPHeader">
                <nav class="main-nav overlay clearfix">
                    <a class="menu-button" href="#">
                        <span class="burger">&#9776;</span>
                        <span class="word">Menu</span>
                    </a>
                </nav>
                <div class="vertical">
                    <div class="main-header-content inner">
                    </div>
                </div>
            </header>
<main id="content" class="content" role="main">
    <article class="post" itemscope="" itemtype="http://schema.org/BlogPosting" itemprop="blogPost">
        <header class="post-header">
            <h1 class="post-title" itemprop="headline">Alembic Quickstart</h1>
            <section class="post-meta">
                <time class="post-date" itemprop="datePublished" datetime="2015YYY-00M-%DD">수요일, 11월 25, 2015</time>
                on <a href="tag/python.html">Python, </a><a href="tag/alembic.html">Alembic, </a><a href="tag/sqlalchemy.html">Sqlalchemy</a>            </section>
        </header>
        <section class="post-content">
            <h2>개요</h2>
<p>Rails나 Django 같은 모던 웹 프레임워크의 ORM에서는, 반복되는 DB 스키마 변경을 수월하게 진행 할 수 있도록 전용 마이그레이션 툴이 ORM에 내장되어 있다. 그러나 SQLAlchemy에서는 기본적으로 테이블의 생성은 가능하나, 생성된 테이블의 스키마 변경은 지원하지 않는데, 이를 수월하게 만들어 주는 툴이 바로 Alembic이다.</p>
<p><br></p>
<h2>설치</h2>
<p>그냥 <code>pip</code>으로 설치한다.</p>
<div class="highlight"><pre><span></span>pip install alembic
</pre></div>


<p><br></p>
<h2>프로젝트 생성</h2>
<p>원하는 디렉토리에서</p>
<div class="highlight"><pre><span></span>alembic init alembic
</pre></div>


<p>을 실행하면 다음과 같은 디렉토리 구조가 생긴다.</p>
<div class="highlight"><pre><span></span>yourproject/
    alembic/
        env.py
        README
        script.py.mako
        versions/
            3512b954651e_add_account.py
            2b1ae634e5cd_add_order_id.py
            3adcc9a56557_rename_username_field.py
</pre></div>


<ul>
<li>yourproject: root 디렉토리</li>
<li>env.py: Alembic이 실행될 때 환경을 설정하기 위해 먼저 실행되는 설정용 스크립트</li>
<li>versions: 실제 <code>revision</code><sup id="fnref-1"><a class="footnote-ref" href="#fn-1">1</a></sup>가 순차적으로 쌓이는 디렉토리</li>
<li>alembic.ini: 설정 변수들이 저장되는 파일. <code>env.py</code>에서 이 파일을 읽어서 설정값을 채움</li>
</ul>
<p><br></p>
<h2>기본 환경 설정</h2>
<p><code>alembic.ini</code> 파일을 열어서 <code>sqlalchemy.url</code> 변수에 원하는 데이터베이스의 URL을 입력한다. 만약 로컬, 개발, 상용 등의 환경 분리가 필요하다면 아예 ini 파일을 따로 만들어서 Alembic 명령어를 <code>-c</code> 옵션과 함께 줄 수 있다.</p>
<div class="highlight"><pre><span></span>alembic -c development.ini upgrade head
</pre></div>


<p>혹은 하나의 파일 내부에 대괄호를 이용해서 이름을 붙여 나눌 수도 있다.</p>
<div class="highlight"><pre><span></span><span class="o">[</span>development<span class="o">]</span>
sqlalchemy.url <span class="o">=</span> dev_db_url

<span class="o">[</span>production<span class="o">]</span>
sqlalchemy.url <span class="o">=</span> prod_db_url

alembic --name development upgrade head
</pre></div>


<p><br></p>
<h2>Revision 생성</h2>
<p>적용을 원하는 Alembic 환경의 root 디렉토리로 이동하고, <code>revision</code>의 이름을 지정하여 생성한다.</p>
<div class="highlight"><pre><span></span>alembic revision -m <span class="s1">&#39;create some table&#39;</span>
</pre></div>


<p><code>versions</code> 디렉토리에 생성된 스크립트를 보면 <code>upgrade</code>와 <code>downgrade</code> 메소드가 있는데, 이곳에 원하는 로직을 채워 넣으면 된다.<sup id="fnref-2"><a class="footnote-ref" href="#fn-2">2</a></sup> 로직은 SQLAlchemy의 객체와 메소드를 이용한다.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">upgrade</span><span class="p">():</span>
    <span class="n">op</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span>
        <span class="s1">&#39;account&#39;</span><span class="p">,</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="mi">200</span><span class="p">)),</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">downgrade</span><span class="p">():</span>
    <span class="n">op</span><span class="o">.</span><span class="n">drop_table</span><span class="p">(</span><span class="s1">&#39;account&#39;</span><span class="p">)</span>
</pre></div>


<p>물론 SQLAlchemy가 raw SQL을 지원하므로 이에 맞춰 직접 SQL을 작성할 수도 있다.</p>
<p><br></p>
<h2>생성된 Revision 적용</h2>
<p>적용을 원하는 Alembic 환경의 root 디렉토리로 이동하고, 명령어를 입력한다. 다음의 명령어를 사용하면 자유자재로 스키마 버전을 왔다갔다 할 수 있다.</p>
<ol>
<li>가장 최신의 마이그레이션 스크립트까지 순차 적용</li>
</ol>
<div class="highlight"><pre><span></span>alembic upgrade head
</pre></div>


<ol>
<li>현재 마이그레이션 버전으로 부터 한단계 상위의 스크립트만 적용</li>
</ol>
<div class="highlight"><pre><span></span>alembic upgrade +1
</pre></div>


<ol>
<li>원하는 단계만큼 롤백</li>
</ol>
<div class="highlight"><pre><span></span>alembic downgrade -1
</pre></div>


<p><br></p>
<h2>Revision 자동 생성</h2>
<p><code>upgrade</code>, <code>downgrade</code> 메소드를 직접 구현하지 않고, 변경한 SQLAlchemy 모델(<code>Base</code>를 상속받은 클래스)을 자동으로 감지하여 마이그레이션 스크립트를 생성 할 수 있다.</p>
<div class="highlight"><pre><span></span>alembic revision --autogenerate -m <span class="s1">&#39;some messages&#39;</span>
</pre></div>


<p>하지만 먼저, 이 기능을 이용하려면 <code>env.py</code> 파일을 이용해서 Alembic이 SQLAlchemy의 변경 사항을 자동으로 감지할 수 있도록 설정해 주어야 한다.</p>
<p><code>env.py</code> 파일을 열고 다음과 같이 입력 혹은 수정한다.</p>
<div class="highlight"><pre><span></span><span class="c1"># SQLAlchemy의 모델 메타데이터를 가져옴</span>
<span class="kn">from</span> <span class="nn">app.database</span> <span class="kn">import</span> <span class="n">Base</span>
<span class="n">target_metadata</span> <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span>

<span class="k">def</span> <span class="nf">run_migrations_online</span><span class="p">():</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="n">engine_from_config</span><span class="p">(</span>
        <span class="n">config</span><span class="o">.</span><span class="n">get_section</span><span class="p">(</span>
            <span class="n">config</span><span class="o">.</span><span class="n">config_ini_section</span><span class="p">,</span>
            <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;sqlalchemy.&#39;</span><span class="p">,</span>
            <span class="n">poolclass</span><span class="o">=</span><span class="n">pool</span><span class="o">.</span><span class="n">NullPool</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">context</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
            <span class="n">connection</span><span class="o">=</span><span class="n">connection</span><span class="p">,</span>
            <span class="c1"># 가져온 메타데이터를 넣는 부분</span>
            <span class="n">target_metadata</span><span class="o">=</span><span class="n">target_metadata</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="n">context</span><span class="o">.</span><span class="n">begin_transaction</span><span class="p">():</span>
            <span class="n">context</span><span class="o">.</span><span class="n">run_migrations</span><span class="p">()</span>
</pre></div>


<p><code>--autogenerate</code> 옵션이 모든 변화를 전부 감지 할 수 있는 것은 아니다. 따라서 자동으로 <code>revision</code>을 생성했다면, 꼭 한 번 파일을 열어서 의도한대로 스크립트가 생성되었는지 점검하는 것이 좋다. 이와 관련해서 자세한 내용은 공식 문서<a href="http://alembic.zzzcomputing.com/en/latest/autogenerate.html#what-does-autogenerate-detect-and-what-does-it-not-detect">What Does Autogenerate Detec</a>를 참조하길 바란다.</p>
<p><br></p>
<div class="footnote">
<hr>
<ol>
<li id="fn-1">
<p>각각의 Migration Script를 의미한다.&#160;<a class="footnote-backref" href="#fnref-1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn-2">
<p><code>upgrade</code>에는 현재 변화를 원하는 로직을, <code>downgrade</code>에는 롤백용 로직을 넣으면 된다.&#160;<a class="footnote-backref" href="#fnref-2" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
</ol>
</div>
        </section>
        <footer class="post-footer">
            <figure class="author-image">
                <a class="img" href="author/qodot.html" style="background-image: url('/images/profile.png')"><span class="hidden">qodot's Picture</span></a>
            </figure>
            <section class="author">
                <h4>
                    <a href="author/qodot.html">qodot</a>
                </h4>
                <p>Python Developer</p>
                <div class="author-meta">
                    <span class="author-location icon-location">Seoul, South Korea</span>                 </div>
            </section>
            <section class="share">
                <h4>Share this post</h4>
                <a class="icon-twitter" href="https://twitter.com/share?text=Alembic%20Quickstart%20via%20%40&amp;url=https://qodot.github.io/Alembic-Quickstart.html" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://qodot.github.io/Alembic-Quickstart.html" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=https://qodot.github.io/Alembic-Quickstart.html" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>
 <section>
<h2>Comments !</h2>
<div id="disqus_thread"></div>
<script type="text/javascript">var disqus_identifier = "Alembic-Quickstart.html";(function(){var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;dsq.src = '//qodot.disqus.com/embed.js';(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);})();</script>
</section>         </footer>
    </article>
</main>
<aside class="read-next">
</aside>             <footer class="site-footer clearfix" role="contentinfo" itemscope itemtype="http://schema.org/WPFooter">
                <section class="copyright">
                    <a itemprop="url" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">
                        CC Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
                </section>
                <section class="poweredby">
                    Proudly published with
                    <a itemprop="url" href="https://getpelican.org" target="_blank">Pelican</a>
                </section>
            </footer>
        </div>
    <script type="text/javascript" src="https://qodot.github.io/theme/js/jquery-1.11.2.min.js"></script>
    <script type="text/javascript" src="https://qodot.github.io/theme/js/jquery.fitvids.min.js"></script>
    <script type="text/javascript" src="https://qodot.github.io/theme/js/index.min.js"></script>
    </body>
</html>